<!DOCTYPE html>
<html>
  <head>
    <title>Gitty</title>
    <style type="text/css">
      body {
        font-family: "Open Sans", Helvetica, Arial, sans-serif;
      }

      body > header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        padding: 0 15px;
        border-bottom: 4px solid #bbb;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      body > header > h1 {
        font-size: 48pt;
        line-height: 64px;
        margin: 0 auto;
        padding: 0;
      }

      body > nav {
        position: absolute;
        top: 64px;
        left: 0;
        width: 200px;
        padding: 0 15px;
      }

      body > nav > ul {
        list-style: none;
        padding-left: 0;
      }

      body > nav > ul > li > a {
        display: block;
        color: #888;
        padding: 5px 15px;
        text-decoration: none;
      }

      body > nav > ul > li > a:hover {
        background-color: #def;
        color: #000;
      }

      main {
        position: absolute;
        top: 64px;
        left: 230px;
        right: 0;
        padding: 0 15px;
      }

      h1 small {
        color: #777;
      }

      pre.error {
        background-color: #fee;
      }

      textarea {
        width: 100%;
      }
    </style>

    <script>
      var fs    = require('fs'),
          path  = require('path'),
          spawn = require('child_process').spawn;

      window.addEventListener('load', function() {
        var navLinks = document.querySelectorAll('body > nav > ul > li > a'),
            mainArea = document.querySelector('body > main');

        var sections = {
          stage: {
            init: function init() {
              runCommand('git', ['status']);
            }
          },

          files: {
            init: function files() {
              runCommandThen('ls', [], function(data) {
                var list = insertElement(mainArea, 'UL');

                forEach(data.split('\n'), function(line) {
                  // Skip blank lines.
                  if ((/^\s*$/).test(line)) {
                    return;
                  }

                  var item = insertElement(list, 'LI'),
                      link = insertElement(item, 'A');

                  // Yeah yeah, I know... boo hoo.
                  link.setAttribute('href', 'javascript:void(0);');

                  link.addEventListener('click', function() {
                    openFile(line);
                  });

                  link.textContent = line;
                });
              });
            }
          }
        };

        forEach(navLinks, function(link) {
          link.addEventListener('click', function(e) {
            e.preventDefault();

            var section = link.getAttribute('href').substring(1);
            visitSection(section);
          });
        });

        function forEach(collection, fn) {
          return Array.prototype.forEach.call(collection, fn);
        }

        function peek(collection) {
          return collection[collection.length - 1];
        }

        function visitSection(section) {
          section = sections[section];
          mainArea.innerHTML = '';
          section.init();
        }

        function insertElement(parent, name, className) {
          var element = document.createElement(name);
          if (className) {
            element.className = className;
          }
          parent.appendChild(element);
          return element;
        }

        function runCommandThen(command, args, callbacks) {
          args      || (args = []);
          callbacks || (callbacks = {});

          if (typeof callbacks === 'function') {
            callbacks = { stdout: callbacks };
          }

          var proc = spawn(command, args, {
            cwd: process.env['PWD']
          });

          proc.stdout.setEncoding('utf8');
          proc.stdout.on('data', callbacks.stdout || function() {});

          proc.stderr.setEncoding('utf8');
          proc.stderr.on('data', callbacks.stderr || function() {});
        }

        function runCommand(command, args) {
          runCommandThen(command, args, {
            stdout: function(data) {
              var pre = insertElement(mainArea, 'PRE');
              pre.textContent = data;
            },

            stderr: function(data) {
              var pre = insertElement(mainArea, 'PRE', 'error');
              pre.textContent = data;
            }
          });
        }

        function openFile(relativePath) {
          var absolutePath = path.join(process.env['PWD'], relativePath);

          fs.readFile(absolutePath, 'utf8', function(err, text) {
            if (err) {
              console.error(err);
              return;
            }

            mainArea.innerHTML = '';
            var textarea = insertElement(mainArea, 'TEXTAREA');
            textarea.value = text;
          });
        }
      });
    </script>
  </head>

  <body>
    <header>
        <h1>
            Gitty
            <small>Node <script>document.write(process.version)</script></small>
        </h1>
    </header>

    <nav>
        <ul>
            <li><a href="#stage">Stage</a></li>
            <li><a href="#files">Files</a></li>
        </ul>
    </nav>

    <main></main>
  </body>
</html>
